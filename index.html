<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>사건/순찰차 위치 저장 & 불러오기 툴</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  body { margin:0; padding:0; }
  #map { width:100%; height:90vh; }
  #controls { padding:10px; text-align:center; }
  button { margin: 5px; padding: 8px 12px; font-size:14px; }
  input[type=file] { margin: 5px; }
</style>
</head>
<body>
<div id="controls">
  <button onclick="setMode('incident')">📍 사건 위치 찍기</button>
  <button onclick="setMode('car')">🚔 순찰차 위치 찍기</button>
  <button onclick="downloadJSON()">💾 JSON 다운로드</button>
  <input type="file" id="fileInput" accept=".json" />
</div>
<div id="map"></div>

<script>
let map = L.map('map').setView([37.5665, 126.9780], 13); // 서울시청 기준
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

let mode = null;
let incidentMarkers = [];
let carMarkers = [];

// 📌 모드 설정
function setMode(type){
  mode = type;
  alert(type === 'incident' ? "사건 위치를 지도에 클릭하세요." : "순찰차 위치를 지도에 클릭하세요.");
}

// 📌 지도 클릭 시 마커 추가
map.on('click', function(e){
  if(!mode) return;
  
  let marker;
  if(mode === 'incident'){
    marker = L.marker(e.latlng, {draggable:true}).addTo(map).bindPopup("사건 위치");
    incidentMarkers.push(marker);
  } else if(mode === 'car'){
    marker = L.marker(e.latlng, {draggable:true, icon: L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/68/68557.png",
      iconSize: [32,32]
    })}).addTo(map).bindPopup("순찰차 위치");
    carMarkers.push(marker);
  }
});

// 📌 JSON 다운로드
function downloadJSON(){
  let data = {
    incidents: incidentMarkers.map(m => m.getLatLng()),
    cars: carMarkers.map(m => m.getLatLng())
  };
  let blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url;
  a.download = "locations.json";
  a.click();
  URL.revokeObjectURL(url);
}

// 📌 JSON 수동 불러오기
document.getElementById('fileInput').addEventListener('change', function(evt){
  let file = evt.target.files[0];
  if(!file) return;

  let reader = new FileReader();
  reader.onload = function(e){
    let data = JSON.parse(e.target.result);
    loadLocations(data);
  };
  reader.readAsText(file);
});

// 📌 공통 로드 함수
function loadLocations(data){
  // 기존 마커 제거
  incidentMarkers.forEach(m => map.removeLayer(m));
  carMarkers.forEach(m => map.removeLayer(m));
  incidentMarkers = [];
  carMarkers = [];

  // 사건 위치 로드
  if(data.incidents){
    data.incidents.forEach(loc => {
      let marker = L.marker(loc, {draggable:true}).addTo(map).bindPopup("사건 위치");
      incidentMarkers.push(marker);
    });
  }

  // 순찰차 위치 로드
  if(data.cars){
    data.cars.forEach(loc => {
      let marker = L.marker(loc, {draggable:true, icon: L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/68/68557.png",
        iconSize: [32,32]
      })}).addTo(map).bindPopup("순찰차 위치");
      carMarkers.push(marker);
    });
  }

  // 지도의 중심을 사건/순찰차 위치 평균으로 맞춤
  let all = [...incidentMarkers, ...carMarkers];
  if(all.length > 0){
    let group = L.featureGroup(all);
    map.fitBounds(group.getBounds().pad(0.3));
  }
}

// 📌 페이지 로딩 시 locations.json 자동 불러오기
fetch('locations.json')
  .then(response => {
    if(!response.ok) throw new Error("파일 없음");
    return response.json();
  })
  .then(data => {
    loadLocations(data);
  })
  .catch(err => {
    console.log("자동 불러오기 실패:", err.message);
  });
</script>
</body>
</html>
