<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>ì‚¬ê±´/ìˆœì°°ì°¨ ë°°ì¹˜ ë° ê¸¸ì°¾ê¸°</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<style>
  #map { height: 90vh; }
  #controls { padding: 10px; text-align:center; }
  button, input { margin: 5px; padding: 6px 10px; font-size:14px; }
</style>
</head>
<body>

<div id="controls">
  <button onclick="setMode('incident')">ğŸ“ ì‚¬ê±´ ìœ„ì¹˜ ì°ê¸°</button>
  <button onclick="setMode('patrol')">ğŸš” ìˆœì°°ì°¨ ìœ„ì¹˜ ì°ê¸°</button>
  <button onclick="downloadJSON()">ğŸ’¾ JSON ì €ì¥</button>
  <input type="file" id="fileInput" accept=".json" />
  <button onclick="selectPatrolForRouting()">ğŸ›£ï¸ ê¸¸ì°¾ê¸° ëª¨ë“œ</button>
</div>
<div id="map"></div>

<script>
let map = L.map('map').setView([37.5665, 126.9780], 13);

// íƒ€ì¼
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom: 19
}).addTo(map);

// ì•„ì´ì½˜
const incidentIcon = L.icon({
  iconUrl:"https://cdn-icons-png.flaticon.com/512/463/463574.png",
  iconSize:[35,35],
  iconAnchor:[17,35],
  popupAnchor:[0,-30]
});
const patrolIcon = L.icon({
  iconUrl:"https://cdn-icons-png.flaticon.com/512/296/296216.png",
  iconSize:[40,40],
  iconAnchor:[20,40],
  popupAnchor:[0,-35]
});

// ìƒíƒœ
let mode = "incident";
let incidentMarker = null;
let patrolMarkers = [];
let routingControl = null;

// ëª¨ë“œ ì„ íƒ
function setMode(m){
  mode = m;
  alert(m === 'incident' ? "ì‚¬ê±´ ìœ„ì¹˜ í´ë¦­" : "ìˆœì°°ì°¨ ë°°ì¹˜ í´ë¦­");
}

// ì§€ë„ í´ë¦­
map.on('click', function(e){
  if(mode === 'incident'){
    if(incidentMarker) map.removeLayer(incidentMarker);
    incidentMarker = L.marker(e.latlng, {icon: incidentIcon}).bindPopup("ì‚¬ê±´ ìœ„ì¹˜").addTo(map);
  }
  else if(mode === 'patrol'){
    let num = prompt("ìˆœì°°ì°¨ ë²ˆí˜¸ ì…ë ¥", "101");
    if(num){
      let marker = L.marker(e.latlng,{icon:patrolIcon}).bindPopup("ìˆœì°°ì°¨ "+num).addTo(map);
      patrolMarkers.push({marker,num});
    }
  }
});

// JSON ì €ì¥
function downloadJSON(){
  let data = {
    incident: incidentMarker ? incidentMarker.getLatLng() : null,
    patrols: patrolMarkers.map(p=>({num:p.num, latlng:p.marker.getLatLng()}))
  };
  let blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  let a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "locations.json";
  a.click();
  URL.revokeObjectURL(a.href);
}

// JSON ë¶ˆëŸ¬ì˜¤ê¸°
document.getElementById('fileInput').addEventListener('change',function(evt){
  let file = evt.target.files[0];
  if(!file) return;
  let reader = new FileReader();
  reader.onload = function(e){
    let data = JSON.parse(e.target.result);

    // ì´ˆê¸°í™”
    if(incidentMarker) map.removeLayer(incidentMarker);
    patrolMarkers.forEach(p=>map.removeLayer(p.marker));
    patrolMarkers = [];

    if(data.incident){
      incidentMarker = L.marker(data.incident,{icon:incidentIcon}).bindPopup("ì‚¬ê±´ ìœ„ì¹˜").addTo(map);
    }
    if(data.patrols){
      data.patrols.forEach(p=>{
        let m = L.marker(p.latlng,{icon:patrolIcon}).bindPopup("ìˆœì°°ì°¨ "+p.num).addTo(map);
        patrolMarkers.push({marker:m,num:p.num});
      });
    }
  };
  reader.readAsText(file);
});

// ìˆœì°°ì°¨ ì„ íƒ í›„ ê¸¸ì°¾ê¸°
function selectPatrolForRouting(){
  if(!incidentMarker){
    alert("ë¨¼ì € ì‚¬ê±´ ìœ„ì¹˜ë¥¼ ì°ì–´ì£¼ì„¸ìš”!");
    return;
  }
  let patrolNum = prompt("ê¸¸ì°¾ê¸°í•  ìˆœì°°ì°¨ ë²ˆí˜¸ ì…ë ¥:");
  let p = patrolMarkers.find(x=>x.num===patrolNum);
  if(!p){
    alert("ì…ë ¥í•œ ë²ˆí˜¸ì˜ ìˆœì°°ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  if(routingControl) map.removeControl(routingControl);
  routingControl = L.Routing.control({
    waypoints:[p.marker.getLatLng(), incidentMarker.getLatLng()],
    routeWhileDragging:true
  }).addTo(map);
}
</script>
</body>
</html>
