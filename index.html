<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>ì‚¬ê±´/ìˆœì°°ì°¨ ë°°ì¹˜ ì‹œë®¬ë ˆì´ì…˜</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  #map { height: 90vh; }
  #controls { padding: 10px; }
</style>
</head>
<body>
<div id="controls">
  <button onclick="downloadJSON()">ğŸ“¥ JSON ì €ì¥</button>
  <input type="file" id="fileInput" accept=".json">
</div>
<div id="map"></div>
<script>
// ì§€ë„ ì´ˆê¸°í™”
const map = L.map('map').setView([37.5665, 126.9780], 13);

// íƒ€ì¼ ë ˆì´ì–´
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// ì•„ì´ì½˜ ì„¤ì •
const patrolIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/296/296216.png", // ğŸš“
  iconSize: [40, 40],
  iconAnchor: [20, 40],
  popupAnchor: [0, -35]
});

const incidentIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/463/463574.png", // â—
  iconSize: [35, 35],
  iconAnchor: [17, 35],
  popupAnchor: [0, -30]
});

// ìƒíƒœ
let mode = "incident"; 
let incidentMarker = null;
let patrolMarkers = [];

// ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
map.on("click", function(e) {
  if (mode === "incident") {
    if (incidentMarker) map.removeLayer(incidentMarker);
    incidentMarker = L.marker(e.latlng, {icon: incidentIcon})
      .bindPopup("ì‚¬ê±´ ìœ„ì¹˜")
      .addTo(map);
  } else if (mode === "patrol") {
    let patrolNum = prompt("ìˆœì°°ì°¨ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:", "101");
    if (patrolNum) {
      let marker = L.marker(e.latlng, {icon: patrolIcon})
        .bindPopup("ìˆœì°°ì°¨ " + patrolNum)
        .addTo(map);
      patrolMarkers.push({marker, num: patrolNum});
    }
  }
});

// JSON ì €ì¥
function downloadJSON() {
  let data = {
    incident: incidentMarker ? incidentMarker.getLatLng() : null,
    patrols: patrolMarkers.map(p => ({
      latlng: p.marker.getLatLng(),
      num: p.num
    }))
  };
  let blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url;
  a.download = "map_data.json";
  a.click();
  URL.revokeObjectURL(url);
}

// JSON ë¶ˆëŸ¬ì˜¤ê¸°
document.getElementById("fileInput").addEventListener("change", function(evt) {
  let file = evt.target.files[0];
  if (!file) return;
  let reader = new FileReader();
  reader.onload = function(e) {
    let data = JSON.parse(e.target.result);

    // ê¸°ì¡´ ë§ˆì»¤ ì´ˆê¸°í™”
    if (incidentMarker) map.removeLayer(incidentMarker);
    patrolMarkers.forEach(p => map.removeLayer(p.marker));
    patrolMarkers = [];

    // ì‚¬ê±´ ìœ„ì¹˜ í‘œì‹œ
    if (data.incident) {
      incidentMarker = L.marker(data.incident, {icon: incidentIcon})
        .bindPopup("ì‚¬ê±´ ìœ„ì¹˜")
        .addTo(map);
    }

    // ìˆœì°°ì°¨ í‘œì‹œ
    if (data.patrols) {
      data.patrols.forEach(p => {
        let marker = L.marker(p.latlng, {icon: patrolIcon})
          .bindPopup("ìˆœì°°ì°¨ " + p.num)
          .addTo(map);
        patrolMarkers.push({marker, num: p.num});
      });
    }
  };
  reader.readAsText(file);
});

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener("keydown", function(e) {
  if (e.key === "1") {
    mode = "incident";
    alert("ì‚¬ê±´ ìœ„ì¹˜ ëª¨ë“œ");
  }
  if (e.key === "2") {
    mode = "patrol";
    alert("ìˆœì°°ì°¨ ë°°ì¹˜ ëª¨ë“œ");
  }
});
</script>
</body>
</html>
