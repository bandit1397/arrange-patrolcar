<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>ì‚¬ê±´/ìˆœì°°ì°¨ ìœ„ì¹˜ ì €ì¥ & ë¶ˆëŸ¬ì˜¤ê¸° íˆ´</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  body { margin:0; padding:0; }
  #map { width:100%; height:90vh; }
  #controls { padding:10px; text-align:center; }
  button { margin: 5px; padding: 8px 12px; font-size:14px; }
  input[type=file] { margin: 5px; }
</style>
</head>
<body>
<div id="controls">
  <button onclick="setMode('incident')">ğŸ“ ì‚¬ê±´ ìœ„ì¹˜ ì°ê¸°</button>
  <button onclick="setMode('car')">ğŸš” ìˆœì°°ì°¨ ìœ„ì¹˜ ì°ê¸°</button>
  <button onclick="downloadJSON()">ğŸ’¾ JSON ë‹¤ìš´ë¡œë“œ</button>
  <input type="file" id="fileInput" accept=".json" />
</div>
<div id="map"></div>

<script>
let map = L.map('map').setView([37.5665, 126.9780], 13); // ì„œìš¸ì‹œì²­ ê¸°ì¤€
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

let mode = null;
let incidentMarkers = [];
let carMarkers = [];

// ğŸ“Œ ëª¨ë“œ ì„¤ì •
function setMode(type){
  mode = type;
  alert(type === 'incident' ? "ì‚¬ê±´ ìœ„ì¹˜ë¥¼ ì§€ë„ì— í´ë¦­í•˜ì„¸ìš”." : "ìˆœì°°ì°¨ ìœ„ì¹˜ë¥¼ ì§€ë„ì— í´ë¦­í•˜ì„¸ìš”.");
}

// ğŸ“Œ ì§€ë„ í´ë¦­ ì‹œ ë§ˆì»¤ ì¶”ê°€
map.on('click', function(e){
  if(!mode) return;
  
  let marker;
  if(mode === 'incident'){
    marker = L.marker(e.latlng, {draggable:true}).addTo(map).bindPopup("ì‚¬ê±´ ìœ„ì¹˜");
    incidentMarkers.push(marker);
  } else if(mode === 'car'){
    marker = L.marker(e.latlng, {draggable:true, icon: L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/68/68557.png",
      iconSize: [32,32]
    })}).addTo(map).bindPopup("ìˆœì°°ì°¨ ìœ„ì¹˜");
    carMarkers.push(marker);
  }
});

// ğŸ“Œ JSON ë‹¤ìš´ë¡œë“œ
function downloadJSON(){
  let data = {
    incidents: incidentMarkers.map(m => m.getLatLng()),
    cars: carMarkers.map(m => m.getLatLng())
  };
  let blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url;
  a.download = "locations.json";
  a.click();
  URL.revokeObjectURL(url);
}

// ğŸ“Œ JSON ìˆ˜ë™ ë¶ˆëŸ¬ì˜¤ê¸°
document.getElementById('fileInput').addEventListener('change', function(evt){
  let file = evt.target.files[0];
  if(!file) return;

  let reader = new FileReader();
  reader.onload = function(e){
    let data = JSON.parse(e.target.result);
    loadLocations(data);
  };
  reader.readAsText(file);
});

// ğŸ“Œ ê³µí†µ ë¡œë“œ í•¨ìˆ˜
function loadLocations(data){
  // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
  incidentMarkers.forEach(m => map.removeLayer(m));
  carMarkers.forEach(m => map.removeLayer(m));
  incidentMarkers = [];
  carMarkers = [];

  // ì‚¬ê±´ ìœ„ì¹˜ ë¡œë“œ
  if(data.incidents){
    data.incidents.forEach(loc => {
      let marker = L.marker(loc, {draggable:true}).addTo(map).bindPopup("ì‚¬ê±´ ìœ„ì¹˜");
      incidentMarkers.push(marker);
    });
  }

  // ìˆœì°°ì°¨ ìœ„ì¹˜ ë¡œë“œ
  if(data.cars){
    data.cars.forEach(loc => {
      let marker = L.marker(loc, {draggable:true, icon: L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/68/68557.png",
        iconSize: [32,32]
      })}).addTo(map).bindPopup("ìˆœì°°ì°¨ ìœ„ì¹˜");
      carMarkers.push(marker);
    });
  }

  // ì§€ë„ì˜ ì¤‘ì‹¬ì„ ì‚¬ê±´/ìˆœì°°ì°¨ ìœ„ì¹˜ í‰ê· ìœ¼ë¡œ ë§ì¶¤
  let all = [...incidentMarkers, ...carMarkers];
  if(all.length > 0){
    let group = L.featureGroup(all);
    map.fitBounds(group.getBounds().pad(0.3));
  }
}

// ğŸ“Œ í˜ì´ì§€ ë¡œë”© ì‹œ locations.json ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
fetch('locations.json')
  .then(response => {
    if(!response.ok) throw new Error("íŒŒì¼ ì—†ìŒ");
    return response.json();
  })
  .then(data => {
    loadLocations(data);
  })
  .catch(err => {
    console.log("ìë™ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err.message);
  });
</script>
</body>
</html>
