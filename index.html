<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>ì‚¬ê±´/ìˆœì°°ì°¨ ë°°ì¹˜ ë° ê¸¸ì°¾ê¸°</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<style>
  body, html { margin:0; padding:0; height:100%; }
  #map { position:absolute; top:150px; bottom:0; left:0; right:0; }
  #controls {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #f5f5f5;
    padding: 10px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    z-index: 1000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }
  button, input[type=file] {
    margin: 5px;
    padding: 12px 15px;
    font-size:16px;
    border-radius:6px;
    border:1px solid #ccc;
    background:#fff;
    cursor:pointer;
    flex: 1 1 45%;
    max-width: 48%;
  }
  button:hover { background:#e0e0e0; }
  input[type=file] { padding:6px; }
</style>
</head>
<body>

<div id="controls">
  <!-- ì‚¬ê±´ ê´€ë ¨ -->
  <button onclick="enableIncidentMode()">ğŸ“ ì‚¬ê±´ ìœ„ì¹˜ ì°ê¸°</button>
  <button onclick="resetIncident()">ğŸ—‘ï¸ ì‚¬ê±´ ì´ˆê¸°í™”</button>

  <!-- ìˆœì°°ì°¨ ê´€ë ¨ -->
  <button onclick="setMode('patrol')">ğŸš” ìˆœì°°ì°¨ ë°°ì¹˜</button>
  <button onclick="resetPatrols()">ğŸ—‘ï¸ ìˆœì°°ì°¨ ì „ì²´ ì´ˆê¸°í™”</button>
  <button onclick="resetSinglePatrol()">ğŸ—‘ï¸ ì§€ì • ìˆœì°°ì°¨ ì´ˆê¸°í™”</button>
  <button onclick="selectPatrolForRouting()">ğŸ›£ï¸ ìˆœì°°ì°¨ ì°¾ê¸°</button>

  <!-- JSON ê´€ë ¨ -->
  <button onclick="downloadJSON()">ğŸ’¾ JSON ì €ì¥</button>
  <input type="file" id="fileInput" accept=".json" />
</div>

<div id="map"></div>

<script>
const PASSWORD = "knp123";

let map = L.map('map').setView([37.5665, 126.9780], 13);

// íƒ€ì¼
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom: 19
}).addTo(map);

// ì•„ì´ì½˜
const incidentIcon = L.icon({
  iconUrl:"https://cdn-icons-png.flaticon.com/512/463/463574.png",
  iconSize:[35,35],
  iconAnchor:[17,35],
  popupAnchor:[0,-30]
});

// ğŸš” ìˆœì°°ì°¨ ì•„ì´ì½˜ â†’ íŒŒë‘ìƒ‰ ìë™ì°¨ ëª¨ì–‘
const patrolIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/743/743007.png", // íŒŒë‘ìƒ‰ ìë™ì°¨
  iconSize: [30, 30],
  iconAnchor: [15, 30],
  popupAnchor: [0, -20]
});

// ìƒíƒœ
let mode = null; // null = ì•„ë¬´ ëª¨ë“œ ì•„ë‹˜, "incident" = ì‚¬ê±´ ëª¨ë“œ, "patrol" = ìˆœì°°ì°¨ ëª¨ë“œ
let incidentMarker = null;
let patrolMarkers = [];
let routingControl = null;

// ì‚¬ê±´ ìœ„ì¹˜ ì°ê¸° í™œì„±í™”
function enableIncidentMode(){
  let pw = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
  if(pw !== PASSWORD){ alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); return; }
  mode = "incident";
  alert("ì§€ë„ì—ì„œ ì‚¬ê±´ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.");
}

// ëª¨ë“œ ì„ íƒ (ìˆœì°°ì°¨)
function setMode(m){
  let pw = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
  if(pw !== PASSWORD){ alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); return; }
  mode = m;
  if(m === 'patrol') alert("ì§€ë„ì—ì„œ ìˆœì°°ì°¨ë¥¼ ë°°ì¹˜í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.");
}

// ì§€ë„ í´ë¦­
map.on('click', function(e){
  if(mode === 'incident'){
    if(incidentMarker) map.removeLayer(incidentMarker);
    incidentMarker = L.marker(e.latlng, {icon: incidentIcon}).bindPopup("ì‚¬ê±´ ìœ„ì¹˜").addTo(map);
    mode = null; // í•œë²ˆ ì§€ì • í›„ ì‚¬ê±´ ëª¨ë“œ ì¢…ë£Œ
  }
  else if(mode === 'patrol'){
    let num = prompt("ìˆœì°°ì°¨ ë²ˆí˜¸ ì…ë ¥", "101");
    if(num){
      let marker = L.marker(e.latlng,{icon:patrolIcon}).bindPopup("ìˆœì°°ì°¨ "+num).addTo(map);
      patrolMarkers.push({marker,num});
    }
  }
});

// JSON ì €ì¥
function downloadJSON(){
  let data = {
    incident: incidentMarker ? {lat: incidentMarker.getLatLng().lat, lng: incidentMarker.getLatLng().lng} : null,
    patrols: patrolMarkers.map(p=>({num:p.num, latlng:{lat:p.marker.getLatLng().lat, lng:p.marker.getLatLng().lng}}))
  };
  let blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  let a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "locations.json";
  a.click();
  URL.revokeObjectURL(a.href);
}

// JSON ë¶ˆëŸ¬ì˜¤ê¸°
document.getElementById('fileInput').addEventListener('change',function(evt){
  let file = evt.target.files[0];
  if(!file) return;
  let reader = new FileReader();
  reader.onload = function(e){
    loadLocations(JSON.parse(e.target.result));
  };
  reader.readAsText(file);
});

// JSON ìë™ ë¡œë“œ
fetch("locations.json")
  .then(res => res.json())
  .then(data => loadLocations(data))
  .catch(err => console.log("locations.json ë¡œë“œ ì‹¤íŒ¨:", err));

function loadLocations(data){
  if(incidentMarker) map.removeLayer(incidentMarker);
  patrolMarkers.forEach(p=>map.removeLayer(p.marker));
  patrolMarkers = [];

  if(data.incident){
    const ll = [data.incident.lat, data.incident.lng];
    incidentMarker = L.marker(ll,{icon:incidentIcon}).bindPopup("ì‚¬ê±´ ìœ„ì¹˜").addTo(map);
  }

  if(data.patrols){
    data.patrols.forEach(p=>{
      const ll = [p.latlng.lat, p.latlng.lng];
      let m = L.marker(ll,{icon:patrolIcon}).bindPopup("ìˆœì°°ì°¨ "+p.num).addTo(map);
      patrolMarkers.push({marker:m,num:p.num});
    });
  }
}

// ê¸¸ì°¾ê¸° (ì¹´ì¹´ì˜¤ë§µ ì—°ë™)
function selectPatrolForRouting(){
  if(patrolMarkers.length === 0){ alert("ìˆœì°°ì°¨ê°€ ë°°ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤!"); return; }
  let patrolNum = prompt("ê¸¸ì°¾ê¸°í•  ìˆœì°°ì°¨ ë²ˆí˜¸ ì…ë ¥:");
  let p = patrolMarkers.find(x=>x.num===patrolNum);
  if(!p){ alert("ì…ë ¥í•œ ë²ˆí˜¸ì˜ ìˆœì°°ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

  if (!navigator.geolocation) { alert("GPSë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

  navigator.geolocation.getCurrentPosition(pos=>{
    const userLat = pos.coords.latitude;
    const userLng = pos.coords.longitude;
    const destLat = p.marker.getLatLng().lat;
    const destLng = p.marker.getLatLng().lng;

    // ì¹´ì¹´ì˜¤ë§µ ê¸¸ì°¾ê¸° URL
    const kakaoUrl = `https://map.kakao.com/link/to/ìˆœì°°ì°¨%20${patrolNum},${destLat},${destLng}?sName=í˜„ìœ„ì¹˜&sX=${userLng}&sY=${userLat}`;
    window.open(kakaoUrl, "_blank");
  }, ()=>{
    alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GPSë¥¼ ì¼œì£¼ì„¸ìš”.");
  });
}

// ì‚¬ê±´ ì´ˆê¸°í™”
function resetIncident(){
  let pw = prompt("ì‚¬ê±´ ì´ˆê¸°í™” ë¹„ë°€ë²ˆí˜¸ ì…ë ¥:");
  if(pw !== PASSWORD){ alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); return; }
  if(incidentMarker){ map.removeLayer(incidentMarker); incidentMarker=null; alert("ì‚¬ê±´ ìœ„ì¹˜ ì´ˆê¸°í™” ì™„ë£Œ"); }
  else alert("ì´ˆê¸°í™”í•  ì‚¬ê±´ ìœ„ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.");
}

// ìˆœì°°ì°¨ ì „ì²´ ì´ˆê¸°í™”
function resetPatrols(){
  let pw = prompt("ìˆœì°°ì°¨ ì´ˆê¸°í™” ë¹„ë°€ë²ˆí˜¸ ì…ë ¥:");
  if(pw !== PASSWORD){ alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); return; }
  patrolMarkers.forEach(p=>map.removeLayer(p.marker));
  patrolMarkers = [];
  alert("ëª¨ë“  ìˆœì°°ì°¨ ìœ„ì¹˜ ì´ˆê¸°í™” ì™„ë£Œ");
}

// ì§€ì • ìˆœì°°ì°¨ ì´ˆê¸°í™”
function resetSinglePatrol(){
  let pw = prompt("ì§€ì • ìˆœì°°ì°¨ ì´ˆê¸°í™” ë¹„ë°€ë²ˆí˜¸ ì…ë ¥:");
  if(pw !== PASSWORD){ alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); return; }
  if(patrolMarkers.length===0){ alert("ì´ˆê¸°í™”í•  ìˆœì°°ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

  let patrolNum = prompt("ì´ˆê¸°í™”í•  ìˆœì°°ì°¨ ë²ˆí˜¸ ì…ë ¥:");
  let index = patrolMarkers.findIndex(x=>x.num===patrolNum);
  if(index===-1){ alert("ì…ë ¥í•œ ë²ˆí˜¸ì˜ ìˆœì°°ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

  map.removeLayer(patrolMarkers[index].marker);
  patrolMarkers.splice(index,1);
  alert("ìˆœì°°ì°¨ "+patrolNum+" ì´ˆê¸°í™” ì™„ë£Œ");
}
</script>
</body>
</html>
